(window.webpackJsonp=window.webpackJsonp||[]).push([[27],{366:function(t,a,s){t.exports=s.p+"assets/img/image-20250728224325083.bd270200.png"},367:function(t,a,s){t.exports=s.p+"assets/img/image-20250728224637293.8ca5a85e.png"},368:function(t,a,s){t.exports=s.p+"assets/img/image-20241010172733008.6aea0f7d.png"},369:function(t,a,s){t.exports=s.p+"assets/img/image-20241014134832686.d23118c7.png"},444:function(t,a,s){"use strict";s.r(a);var n=s(25),e=Object(n.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"手把手教你玩转-一站式运维平台-codo-5-1-安装-codo-agent"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#手把手教你玩转-一站式运维平台-codo-5-1-安装-codo-agent"}},[t._v("#")]),t._v(" 手把手教你玩转 一站式运维平台(CODO) - 5.1 安装 codo-agent")]),t._v(" "),a("h1",{attrs:{id:"codo-agent入门到精通"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#codo-agent入门到精通"}},[t._v("#")]),t._v(" codo-agent入门到精通")]),t._v(" "),a("h2",{attrs:{id:"简单使用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#简单使用"}},[t._v("#")]),t._v(" 简单使用")]),t._v(" "),a("h3",{attrs:{id:"codo-agent"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#codo-agent"}},[t._v("#")]),t._v(" codo-agent")]),t._v(" "),a("h4",{attrs:{id:"启动-agnet"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#启动-agnet"}},[t._v("#")]),t._v(" 启动 agnet")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-L")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-o")]),t._v(" ./codo-agent https://github.com/opendevops-cn/codo-agent-server/releases/download/v1.8.6/codo-agent-linux-amd64\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("chmod")]),t._v(" +x ./codo-agent\n./codo-agent --config-file ./config.yaml\n")])])]),a("h4",{attrs:{id:"配置详情"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置详情"}},[t._v("#")]),t._v(" 配置详情")]),t._v(" "),a("p",[t._v("以下是简单配置:")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 日志等级(必填, 默认 info)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# - DEBUG")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# - INFO")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# - WARN")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# - ERROR")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("LOG-LEVEL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" info\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 业务ID(必填, 默认 502)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("BIZ-ID")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"504"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 连接服务地址(必填, agent-server 的地址, clientId 需要全局唯一)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v('# SERVER-ADDRESS: "ws://127.0.0.1:8002/api/v1/codo/agent?clientId=huaweibook1"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 也可以是 AGENT-PROXY 的地址")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v('# SERVER-ADDRESS: "ws://127.0.0.1:9999/api/v1/codo/agent?clientId=huaweibook1"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 也可以填 demo 的地址")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("SERVER-ADDRESS")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ws://demo.opendevops.cn/api/agent-ws/v1/codo/agent?clientId=cctest"')]),t._v("\n")])])]),a("p",[t._v("以下是全量配置:")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 日志等级(必填, 建议 info)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# - DEBUG")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# - INFO")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# - WARN")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# - ERROR")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("LOG-LEVEL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" info\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# RootPath 日志保存路径(选填, 默认是 工作目录)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 用于：")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# - 存储脚本文件")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# - 存储密钥文件")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# - 存储执行日志文件")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# - 存储agent日志文件")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ROOT-PATH")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"./data/agent"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 连接服务地址(必填, agent-server/proxy 的地址, clientId 需要全局唯一)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("SERVER-ADDRESS")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ws://127.0.0.1:9999/api/v1/codo/agent?clientId=huaweibook1"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 节点类型(选填)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# - normal(默认值)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# - master(当节点为master时，自动开启AGENT代理模式, 用于将多个 AGENT 的连接归并起来一起转发到 AGENT-SERVER)(生产环境推荐使用)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("NODE-TYPE")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"normal"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 业务ID(必填, 默认 502)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("BIZ-ID")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"525"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 本地绑定ip（master模式），本地上报ip地址(选填, 默认取第一张非loppback网卡的ip)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("BIND-IP")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 本地绑定端口（master模式下有效）(选填, 默认 20800)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("BIND-PORT")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("20800")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 日志行数限制(选填, 默认 800)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ROW-LIMIT")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2000")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 最大执行命令数(选填, 默认 100)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("MAX-EXEC-CMD")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 以脚本路径作为工作目录(选填, 默认 false)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("SCRIPT-PATH-AS-WD")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("false")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 强指脚本的工作目录(选填, 默认 工作目录)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("WORK-DIR")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"./data/wd"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 日志清理间隔(单位：天)(选填, 默认 30)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("LOG-CLEAN-INTERVAL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("30")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 实验性参数：WINDOWS 强杀子进程进程树(选填, 默认 false)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("EXPR-FORCE-KILL-SUB-PROC")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("false")]),t._v("\n")])])]),a("h4",{attrs:{id:"修改-agent-id"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#修改-agent-id"}},[t._v("#")]),t._v(" 修改 AGENT ID")]),t._v(" "),a("p",[t._v("agent-id 新版本自动生成, 一旦生成, 一般来说禁止修改.\n如果有必须要修改的需求, 可以在 codo-agent 的工作目录下修改")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-n")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"cctest1"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" ./codo_status/.agent_id\n")])])]),a("h4",{attrs:{id:"agent-绑定业务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#agent-绑定业务"}},[t._v("#")]),t._v(" AGENT 绑定业务")]),t._v(" "),a("p",[t._v("agent 连接上之后会默认进入到 CMDB 的 Agent 列表页面.")]),t._v(" "),a("p",[t._v("点击 "),a("strong",[t._v("生成主机")]),t._v(" 用来在业务树上 绑定 agent 机器")]),t._v(" "),a("p",[a("img",{attrs:{src:s(366),alt:"image-20250728224325083"}})]),t._v(" "),a("blockquote",[a("p",[t._v("注意:")]),t._v(" "),a("p",[t._v("只有集群和模块可以绑定资源, 需要右键业务树节点多创建几层子节点")])]),t._v(" "),a("p",[a("img",{attrs:{src:s(367),alt:"image-20250728224637293"}})]),t._v(" "),a("h3",{attrs:{id:"codo-agent-server"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#codo-agent-server"}},[t._v("#")]),t._v(" codo-agent-server")]),t._v(" "),a("h4",{attrs:{id:"数据库-migrate"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#数据库-migrate"}},[t._v("#")]),t._v(" 数据库 migrate")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("./codo-agent-server migrate --config-file ./config.yaml\n")])])]),a("h4",{attrs:{id:"启动-agent-server"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#启动-agent-server"}},[t._v("#")]),t._v(" 启动 agent-server")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("./codo-agent-server --config-file ./config.yaml\n")])])]),a("h4",{attrs:{id:"配置详情-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置详情-2"}},[t._v("#")]),t._v(" 配置详情")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# HTTP 服务端口(用于接收codo-flow的请求)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("PORT")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("9996")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# GRPC 通信端口(暂时没用, 用于服务注册)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("RPC-PORT")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("9997")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# websocket 连接专用端口(用于codo-agent建立 ws 连接)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("WS-PORT")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("9999")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 性能采集端口(用于提供 metrics )")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("PPROF-PORT")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("9995")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 本机服务监听地址(监听地址, 建议 0.0.0.0)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("BIND-ADDRESS")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 0.0.0.0\n\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 日志存放地址(存放 agent-server 打印的运行日志)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ROOT-PATH")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" E"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\\go\\src\\agent"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("server\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 日志等级(默认 DEBUG)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# - DEBUG")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# - INFO")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# - WARN")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# - ERROR")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("LOG-LEVEL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" DEBUG\n\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# RabbitMQ 配置 (用于将 agent 的日志上报到 codo-flow)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("MQCONFIG")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ENABLED")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("SCHEMA")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"amqp"')]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("HOST")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"127.0.0.1"')]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("PORT")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5672")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("USERNAME")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"admin"')]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("PASSWORD")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"123456"')]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("VHOST")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"codo"')]),t._v("\n\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# MYSQL 配置, 用于存储 agent-server 的数据")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("DB-CONFIG")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("DB-TYPE")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" mysql\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("DB-USER")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" root\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("DB-PASSWORD")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("123456")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("DB-HOST")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 127.0.0.1\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("DB-NAME")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" codo_agent_server\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("DB-TABLE-PREFIX")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" codo_\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("DB-FILE")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("DB-PORT")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3306")]),t._v("\n\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# REDIS 配置")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 用于:")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#  存储 codo-agent 的心跳")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("REDIS")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("R-HOST")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 127.0.0.1\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("R-PORT")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6379")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("R-PASSWORD")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("R-DB")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# REDIS 发布订阅配置")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 用于:")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#  CDMB 任务同步")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#  CODO 任务分发")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("PUBLISH")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("P-HOST")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 127.0.0.1\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("P-PORT")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6379")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("P-PASSWORD")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("P-DB")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("P-ENABLED")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n")])])]),a("h4",{attrs:{id:"接口"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#接口"}},[t._v("#")]),t._v(" 接口")]),t._v(" "),a("h5",{attrs:{id:"下发任务-异步"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#下发任务-异步"}},[t._v("#")]),t._v(" 下发任务(异步)")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-X")]),t._v(" POST "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),t._v(".0.1:9996/api/v1/agent/task/batch "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-H")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Content-Type: application/json'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-d")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('\'[\n    {\n      "taskId": "task123",\n      "taskType": "ExecCmd",\n      "agentId": "agent456",\n      "args": {\n        "cmd": "sh ${script_path}",\n        "timeout": 300,\n        "scriptInfo": "#!/bin/bash\\n echo helloworld",\n\t\t\t\t"scriptParams": "{\\"a\\":1}"\n      }\n    },\n    {\n      "taskId": "task124",\n      "taskType": "RevokeTask",\n      "agentId": "agent789",\n      "args": {"taskId": "11asd"}\n    }\n  ]\'')]),t._v("\n  \n不同的 task-type 对应的 args 参数不同\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v("\nGetRunningTask: 获取正在执行的任务\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\nRevokeTask: 取消任务\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"taskId"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"11asd"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\nExecCmd: 执行任务\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"cmd"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"sh '),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${script_path}")]),t._v('"')]),t._v(", // 执行的命令"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("必填"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${script_path}")]),t._v(" 是一个魔术变量, 当 scriptInfo 有内容时, 会替换成 scriptInfo 存储的路径\n"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"timeout"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("300")]),t._v(", // 任务超时时间\n“scriptInfo”: “"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#!/bin/bash\\n echo helloworld”, // 脚本模式下, 脚本的内容(选填)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"scriptParams"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"{'),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[t._v('\\"')]),t._v("a"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[t._v('\\"')]),t._v(':1}"')]),t._v(" // 额外注入的环境变量信息"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("选填"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n")])])]),a("h5",{attrs:{id:"下发任务-同步"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#下发任务-同步"}},[t._v("#")]),t._v(" 下发任务(同步)")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 获取正在执行的任务")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-X")]),t._v(" POST http://127.0.0.1:9996/api/v1/codo/call "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-H")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Content-Type: application/json'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-d")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('\'{"TaskID": "xxx", "AgentID": "huaweibook1:6666", "TaskType": "GetRunningTask"}\'')]),t._v("\n\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 下发任务")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-X")]),t._v(" POST http://127.0.0.1:9996/api/v1/codo/call "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-H")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Content-Type: application/json'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-d")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('\'{"TaskID": "abc---huaweibook1:6666", "AgentID": "huaweibook1:6666", "TaskType": "ExecCmd", "args":{"cmd":"echo helloworld","scriptParams":"{}"}}\'')]),t._v("\n")])])]),a("h5",{attrs:{id:"如果-tasktype-是-execcmd-可以获取实时日志"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#如果-tasktype-是-execcmd-可以获取实时日志"}},[t._v("#")]),t._v(" 如果  TaskType 是 ExecCmd, 可以获取实时日志")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 获取任务 abc---huaweibook1:6666 的日志")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://127.0.0.1:9996/api/v1/manager/agent/task/logv2?task_id=abc---huaweibook1:6666"')]),t._v("\n")])])]),a("h5",{attrs:{id:"获取在线的-agent-列表"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#获取在线的-agent-列表"}},[t._v("#")]),t._v(" 获取在线的 agent 列表")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("curl 127.0.0.1:9996/api/v1/agent/info\n")])])]),a("h2",{attrs:{id:"网络拓扑"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#网络拓扑"}},[t._v("#")]),t._v(" 网络拓扑")]),t._v(" "),a("p",[t._v("在不同网络分区建立 PROXY 节点，收敛网络流量，由 PROXY 节点统一向外部中心调度服务进行流量传输。")]),t._v(" "),a("h2",{attrs:{id:"任务调度"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#任务调度"}},[t._v("#")]),t._v(" 任务调度")]),t._v(" "),a("blockquote",[a("p",[t._v("之所以推送任务到 redis , 是 因为 agent-server 本身多副本, 对应需要执行任务的 agent 的 ws连接 不一定在 接受到任务下发的 agent-server 上")])]),t._v(" "),a("p",[a("img",{attrs:{src:s(368),alt:"image-20241010172733008"}})]),t._v(" "),a("h3",{attrs:{id:"在-execcmd-时的调度"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#在-execcmd-时的调度"}},[t._v("#")]),t._v(" 在 ExecCmd 时的调度")]),t._v(" "),a("p",[a("img",{attrs:{src:s(369),alt:"image-20241014134832686"}})])])}),[],!1,null,null,null);a.default=e.exports}}]);